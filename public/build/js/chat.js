!function(e){var t=/(@[\u4e00-\u9fa5\w\-]+)/g;e.Operate=function(){this.historyBox=$("#message"),this.wrapper=$(".m-bd"),this.messageInput=$("#sendText")},Operate.prototype.sendMessage=function(){var e=this.messageInput.val().trim(),t=e.substr(0,1),s={from:qv.from,to:qv.to,msg:e};return"$"==t?void qv.socket.emit("system message",s):"all"==qv.to?void qv.socket.emit("message",s):void qv.socket.emit("private message",s)},Operate.prototype.renderMyself=function(e){var t={from:qv.from,to:qv.to,msg:e,time:util.format(new Date,"h:m:ss"),random:qv.userInfo.random,cls:"me"};this.render(t),qv.to="all",this.messageInput.val("")},Operate.prototype.writePrivateMessage=function(e){var t=this.messageInput;"@"!==e.substr(0,1)&&(e="@"+e),t.val(e+" "+t.val())},Operate.prototype.renderPublic=function(e){e.cls="other",this.render(e)},Operate.prototype.renderSystem=function(e){e.cls="system";var t=e.msg;"$"==t.substr(0,1)&&(e.msg=t.substr(1,t.length+1)),this.render(e)},Operate.prototype.renderWhisper=function(e){e.cls="whisper",e.msg=e.msg.replace(t,""),this.render(e)},Operate.prototype.template='<li class="new {{cls}}"><div class="m-user-box"><img src="/img/av/av_{{random}}.jpg" alt="{{from}}" title="{{from}}" class="portrait"></div><div class="m-text-box"><div class="u-username">{{text}}</div><div class="m-message-box"><p>{{msg}}</p><div class="u-time">{{time}}</div></div></div></li>',Operate.prototype.render=function(e){var s=this;switch(e.msg=util.chatToHtml(e.msg).replace(t,'<span data-name="$1" class="at">$1</span>'),e.text='<span class="username">'+e.from+"：</span>",e.cls){case"me":e.text="";break;case"whisper":e.text='<span class="username">'+e.from+"悄悄对你说：</span>";break;case"system":e.text='<span class="username">系统消息：</span>'}var r=util.template(this.template,e);s.historyBox.append(r),s.wrapper.scrollTop(s.historyBox.height())}}(this),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){if(void 0===this||null===this)throw new TypeError('"this" is null or not defined');var s=this.length>>>0;for(t=+t||0,1/0===Math.abs(t)&&(t=0),0>t&&(t+=s,0>t&&(t=0));s>t;t++)if(this[t]===e)return t;return-1}),function(e){var t=/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|&|-)+)/gi;e.util={insertAtCaret:function(e,t){var s=e[0];if(s.createTextRange&&s.caretPos){var r=s.caretPos;r.text=""==r.text.charAt(r.text.length-1)?t+"":t}else if(s.setSelectionRange){var o=s.selectionStart,n=s.selectionEnd,a=s.value.substring(0,o),i=s.value.substring(n);s.value=a+t+i,s.focus();var l=t.length;s.setSelectionRange(o+l,o+l),s.blur()}else s.value+=t;s.focus()},getCookie:function(e){var t,s,r=document.cookie;return r&&""!=r&&(t=r.indexOf(e+"="),-1!=t)?(t+=e.length+1,s=r.indexOf(";",t),-1==s&&(s=r.length),decodeURIComponent(r.substring(t,s))):""},format:function(e,t){var s={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),"S+":e.getMilliseconds()};/(y+)/i.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var r in s)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?s[r]:("00"+s[r]).substr((""+s[r]).length)));return t},urlToAlink:function(e){return e.replace(t,'<a href="$1$2" target="_blank">$1$2</a>')},chatToHtml:function(e){return e=util.urlToAlink(e),e=e.replace(/(\[\/)(\w+)(\])/g,'<img src="http://twemoji.maxcdn.com/36x36/$2.png">')},template:function(e,t){return e.replace(/{{([^}}]+)?}}/g,function(e,s){return t[s]||""})}}}(this),function(e,t){function s(e){var t=e.match(/(@[\u4e00-\u9fa5\w\-]+)/g);if(t){for(var s=t.length-1;s>=0;s--)t[s]=t[s].substr(1);qv.to=t}}e.qv={to:"all",from:util.getCookie("user"),userInfo:{},socket:io.connect(),op:new Operate};var r=t.title;e.onfocus=function(){t.title=r};var o="",n=qv.op.messageInput;n.keydown(function(e){return 13==e.keyCode?(o=n.val(),o.trim()?(s(o),qv.op.sendMessage(),qv.op.renderMyself(o),!1):!1):void(38==e.keyCode&&n.val(o))}),qv.op.historyBox.on("click",".portrait",function(){var e=$(this).attr("alt"),t=n.val();n.val(t+"@"+e+" "),n.focus()});var a=$(e).height(),i=n.parents(".m-send").height();qv.op.wrapper.height(a-i-50);var l,c=$(".m-emo-box"),u=$(".j-emo"),p=$("#emoji-template").html();u.on("click",function(){return!l&&c.html(p),l=1,c.hasClass("hide")?c.removeClass("hide"):void c.addClass("hide")}),c.on("click","img",function(){util.insertAtCaret(qv.op.messageInput,$(this).attr("alt")),c.addClass("hide")})}(this,document),function(e,t){qv.socket.emit("online",{from:qv.from}),qv.socket.on("online",function(e){qv.userInfo=e}),qv.socket.on("message",function(e){qv.op.renderPublic(e),t.title="你有新到消息.."}),qv.socket.on("private message",function(e){console.log(e.to,qv.from),-1!==e.to.indexOf(qv.from)&&(qv.op.renderWhisper(e),t.title="有条私信哦..")}),qv.socket.on("system message",function(e){qv.op.renderSystem(e),t.title="系统消息.."})}(this,document);